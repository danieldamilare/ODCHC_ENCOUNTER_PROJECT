{% extends "admin_base.html" %}

{% block page_header %}
<div class="mb-6 sm:mb-8">
    <nav class="text-sm sm:text-base font-medium text-gray-600 mb-4" aria-label="Breadcrumb">
        <ol class="list-none p-0 flex flex-wrap items-center gap-2">
            <li class="flex items-center">
                <a href="{{ url_for('admin') }}" class="hover:text-indigo-600 transition-colors">Admin</a>
            </li>
            <li class="flex items-center">
                <svg class="h-4 w-4 sm:h-5 sm:w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                <a href="{{ url_for('facilities') }}" class="hover:text-indigo-600 transition-colors">Facilities</a>
            </li>
            <li class="flex items-center">
                <svg class="h-4 w-4 sm:h-5 sm:w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                <span class="text-gray-900 font-semibold" aria-current="page">{{ facility.name }}</span>
            </li>
        </ol>
    </nav>
    <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900">{{ facility.name }}</h1>
            <p class="text-sm sm:text-base text-gray-600 mt-1">{{ facility.facility_type|title }} &middot; {{ facility.lga|title }}</p>
        </div>
        <a href="{{ url_for('edit_facilities', pid=facility.id) }}" class="inline-flex items-center gap-2 px-4 py-2.5 bg-indigo-600 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
              <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
            </svg>
            Edit Facility
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="space-y-8">

    <div>
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Supported Insurance Schemes</h3>
        <div class="flex flex-wrap gap-2">
            {% for scheme_obj in facility.scheme %} {# Assuming facility.scheme is a list of objects now #}
                <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                    {{ scheme_obj.scheme_name }}
                </span>
            {% else %}
                <p class="text-sm text-gray-500 italic">No insurance schemes assigned.</p>
            {% endfor %}
        </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div class="bg-gradient-to-br from-blue-50 via-white to-blue-100 p-6 rounded-xl shadow-lg border border-blue-200 flex items-center gap-4">
             <div class="flex-shrink-0 h-12 w-12 rounded-full bg-blue-500/10 flex items-center justify-center border-2 border-blue-200">
                 <svg class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            </div>
            <div>
                <div class="text-sm font-medium text-gray-500">Total Registered Users</div>
                <div class="mt-1 text-3xl font-bold text-gray-900">{{ user_count }}</div>
            </div>
        </div>
        <div class="bg-gradient-to-br from-green-50 via-white to-green-100 p-6 rounded-xl shadow-lg border border-green-200 flex items-center gap-4">
            <div class="flex-shrink-0 h-12 w-12 rounded-full bg-green-500/10 flex items-center justify-center border-2 border-green-200">
                 <svg class="h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
            </div>
            <div>
                <div class="text-sm font-medium text-gray-500">Encounters This Month</div>
                <div class="mt-1 text-3xl font-bold text-gray-900">{{ month_encounter_count }}</div>
            </div>
        </div>
    </div>

    <div class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden">
        <div class="border-b border-gray-200 bg-gray-50/75">
            <nav class="-mb-px flex space-x-6 px-6" aria-label="Tabs">
                <button id="tab-encounters" data-target="panel-encounters" role="tab" aria-controls="panel-encounters" aria-selected="true"
                        class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-indigo-600 border-indigo-500">
                    Recent Encounters
                </button>
                <button id="tab-users" data-target="panel-users" role="tab" aria-controls="panel-users" aria-selected="false"
                        class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">
                    Users at this Facility
                </button>
            </nav>
        </div>

        <div>
            <div id="panel-encounters" role="tabpanel" aria-labelledby="tab-encounters" class="tab-panel p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800">Recent Encounters (This Month)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client Name</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Age</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for encounter in recent_encounters %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{{ encounter.client_name }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ encounter.date.strftime('%b %d, %Y') }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ encounter.age }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="px-4 py-6 text-center text-sm text-gray-500 italic">No encounters found for this facility this month.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="panel-users" role="tabpanel" aria-labelledby="tab-users" class="tab-panel p-6 hidden">
                <div class="flex items-center justify-between mb-4">
                     <h2 class="text-xl font-bold text-gray-800">Users at this Facility</h2>
                     <button id="open-add-user-modal-btn" type="button" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M11 5a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V5z" /><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-.001-8.915a3.982 3.982 0 00-2.484.773 4.01 4.01 0 00-1.28 1.258C5.02 12.77 4 14.89 4 17h12c0-2.11-.983-4.156-2.15-5.698a4.01 4.01 0 00-1.28-1.258 3.982 3.982 0 00-2.484-.773zM10 4a2 2 0 100 4 2 2 0 000-4z" clip-rule="evenodd" /></svg>
                        Add User to Facility
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                <th class="relative px-4 py-3"><span class="sr-only">Edit</span></th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for user in user_list %} {# Assuming user_list is passed for this facility #}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{{ user.username }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                     {% if user.role.name == 'admin' %} {# Should typically only be Facility Users here? #}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">Admin</span>
                                     {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Facility User</span>
                                     {% endif %}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                    <a href="{{ url_for('edit_user', user_id=user.id) }}" class="text-indigo-600 hover:text-indigo-900">Edit</a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="px-4 py-6 text-center text-sm text-gray-500 italic">No users found at this facility.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                 <nav class="mt-6 flex items-center justify-between" aria-label="Pagination">
                     <div>
                         {% if prev_url %}<a href="{{ prev_url }}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Previous</a>{% else %}<span class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-400 bg-gray-50 cursor-not-allowed">Previous</span>{% endif %}
                     </div>
                     <div>
                         {% if next_url %}<a href="{{ next_url }}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Next</a>{% else %}<span class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-400 bg-gray-50 cursor-not-allowed">Next</span>{% endif %}
                     </div>
                 </nav>
            </div>
        </div>
    </div> </div> <div id="add-user-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div id="modal-backdrop" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity opacity-0" aria-hidden="true"></div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form action="{{ url_for('view_facilities', pid=facility.id) }}" method="post" novalidate>
                {{ user_form.hidden_tag() }}
                 <input type="hidden" name="facility_id" value="{{ facility.id }}">

                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-primary-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Add New User to {{ facility.name }}
                            </h3>
                            <div class="mt-4 space-y-4">
                                <div>
                                    <label for="{{ user_form.username.id }}" class="block text-sm font-medium text-gray-700">{{ user_form.username.label.text }} <span class="text-red-500">*</span></label>
                                    <div class="relative mt-1">
                                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                        </div>
                                        {{ user_form.username(class="block w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all") }}
                                    </div>
                                    {% for error in user_form.username.errors %}<span class="text-red-500 text-xs mt-1">{{ error }}</span>{% endfor %}
                                </div>
                                <div>
                                    <label for="{{ user_form.password.id }}" class="block text-sm font-medium text-gray-700">{{ user_form.password.label.text }} <span class="text-red-500">*</span></label>
                                     <div class="relative mt-1">
                                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                                        </div>
                                        {{ user_form.password(class="block w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all") }}
                                    </div>
                                    {% for error in user_form.password.errors %}<span class="text-red-500 text-xs mt-1">{{ error }}</span>{% endfor %}
                                </div>
                                <div>
                                    <label for="{{ user_form.password2.id }}" class="block text-sm font-medium text-gray-700">{{ user_form.password2.label.text }} <span class="text-red-500">*</span></label>
                                    <div class="relative mt-1">
                                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                                        </div>
                                        {{ user_form.password2(class="block w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all") }}
                                    </div>
                                    {% for error in user_form.password2.errors %}<span class="text-red-500 text-xs mt-1">{{ error }}</span>{% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-3">
                    {{ user_form.submit(class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:w-auto sm:text-sm transition-colors") }}
                    <button id="close-add-user-modal-btn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Tab Handling ---
        const tabs = document.querySelectorAll('.tab-button');
        const panels = document.querySelectorAll('.tab-panel');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Deactivate all tabs and panels
                tabs.forEach(t => {
                    t.classList.remove('text-indigo-600', 'border-indigo-500');
                    t.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
                    t.setAttribute('aria-selected', 'false');
                });
                panels.forEach(p => p.classList.add('hidden'));

                // Activate the clicked tab and its panel
                tab.classList.add('text-indigo-600', 'border-indigo-500');
                tab.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
                tab.setAttribute('aria-selected', 'true');

                const targetPanelId = tab.getAttribute('data-target');
                const targetPanel = document.getElementById(targetPanelId);
                if (targetPanel) {
                    targetPanel.classList.remove('hidden');
                }
            });
        });

        // --- Add User Modal Handling ---
        const modal = document.getElementById('add-user-modal');
        const openBtn = document.getElementById('open-add-user-modal-btn');
        const closeBtn = document.getElementById('close-add-user-modal-btn');
        const backdrop = document.getElementById('modal-backdrop');

        function openModal() {
            if (!modal) return;
            modal.classList.remove('hidden');
            if (backdrop) {
                 backdrop.classList.remove('opacity-0');
                 backdrop.classList.add('opacity-100');
            }
        }

        function closeModal() {
            if (!modal) return;
             if (backdrop) {
                backdrop.classList.remove('opacity-100');
                backdrop.classList.add('opacity-0');
            }
            setTimeout(() => {
                 modal.classList.add('hidden');
            }, 150);
        }

        if (openBtn) {
            openBtn.addEventListener('click', openModal);
        }
        if (closeBtn) {
            closeBtn.addEventListener('click', closeModal);
        }
        if (backdrop) {
            backdrop.addEventListener('click', closeModal);
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });

        // If form had errors on page load, open the modal AND switch to the Users tab
        {% if user_form.errors %}
            openModal();
            // Simulate click on Users tab to show it
            document.getElementById('tab-users').click();
        {% endif %}
    });
</script>
{% endblock %}