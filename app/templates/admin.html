{% extends "admin_base.html" %}

{% block content %}
<div class="space-y-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Dashboard</h1>
            <p class="text-md text-gray-500">Analytics overview of encounter data.</p>
        </div>
        
        <form id="filter-form" method="GET" action="{{ url_for('admin') }}" class="flex items-center gap-4">
            <div class="flex-1">
                <label for="period" class="sr-only">Date Range</label>
                <select id="period" name="period" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option value="this_month" {% if current_period == 'this_month' %}selected{% endif %}>This Month</option>
                    <option value="last_3_months" {% if current_period == 'last_3_months' %}selected{% endif %}>Last 3 Months</option>
                    <option value="last_year" {% if current_period == 'last_year' %}selected{% endif %}>Last Year</option>
                </select>
            </div>
            <div class="flex-1">
                <label for="facility_id" class="sr-only">Facility</label>
                <select id="facility_id" name="facility_id" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option value="all">All Facilities</option>
                    {% for facility in all_facilities %}
                        <option value="{{ facility.id }}" {% if current_facility_id|int == facility.id %}selected{% endif %}>{{ facility.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
            <div class="text-sm font-medium text-gray-500">Total Encounters</div>
            <div class="mt-1 text-3xl font-bold text-gray-800">{{ total_encounters }}</div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
            <div class="text-sm font-medium text-gray-500">Active Facilities</div>
            <div class="mt-1 text-3xl font-bold text-gray-800">{{ active_facilities }}</div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
            <div class="text-sm font-medium text-gray-500">Most Common Disease</div>
            <div class="mt-1 text-2xl font-bold text-gray-800 truncate">{{ top_disease.disease_name if top_disease else 'N/A' }}</div>
            <p class="text-sm text-gray-500">{{ top_disease.disease_count if top_disease else 0 }} cases</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
            <div class="text-sm font-medium text-gray-500">Male / Female Ratio</div>
            <div class="mt-1 text-2xl font-bold text-gray-800">{{ male_perc }}% / {{ female_perc }}%</div>
            <p class="text-sm text-gray-500">Male vs Female</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Daily Encounter Trend (Last 7 Days)</h2>
            <canvas id="dailyTrendChart"></canvas>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Age Group Distribution</h2>
            <canvas id="ageDistributionChart"></canvas>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Top 5 Most Common Diseases</h2>
            <canvas id="topDiseasesChart"></canvas>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Top 5 Visited Facilities</h2>
            <canvas id="topFacilitiesChart"></canvas>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg">
        <h2 class="text-xl font-bold text-gray-800 p-6">Recent Encounters</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Policy #</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Facility</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Disease</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for encounter in recent_encounters %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ encounter.policy_number }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ encounter.client_name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ encounter.facility.name }}</td>

                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% for dis in encounter.diseases %}
                                {% if loop.index0 > 0 %}, {% endif %}
                                {{ dis.name }}
                            {% endfor %}

                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">No recent encounters found for this period.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- AUTO-SUBMIT FORM ON CHANGE ---
        const form = document.getElementById('filter-form');
        const periodSelect = document.getElementById('period');
        const facilitySelect = document.getElementById('facility_id');

        periodSelect.addEventListener('change', () => form.submit());
        facilitySelect.addEventListener('change', () => form.submit());

        // --- CHART DATA ---
        const dailyTrendData = {{ daily_trend_raw|tojson }};
        const ageDistributionData = {{ age_distribution|tojson }};
        const topDiseasesData = {{ top_diseases|tojson }};
        const topFacilitiesData = {{ top_facilities_raw|tojson }};
        
        // --- 1. DAILY ENCOUNTER TREND CHART ---
        if (dailyTrendData && dailyTrendData.length > 0) {
            const ctxDaily = document.getElementById('dailyTrendChart').getContext('2d');
            new Chart(ctxDaily, {
                type: 'line',
                data: {
                    labels: dailyTrendData.map(d => d.day),
                    datasets: [{
                        label: 'Encounters',
                        data: dailyTrendData.map(d => d.date_count),
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } },
                },
            });
        }

        // --- 2. AGE DISTRIBUTION CHART ---
        if (ageDistributionData && ageDistributionData.length > 0) {
            const ctxAge = document.getElementById('ageDistributionChart').getContext('2d');
            new Chart(ctxAge, {
                type: 'bar',
                data: {
                    labels: ageDistributionData.map(d => d.age_group),
                    datasets: [{
                        label: 'Total Patients',
                        data: ageDistributionData.map(d => d.age_group_count),
                        backgroundColor: '#60a5fa',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                },
            });
        }
        
        // --- 3. TOP DISEASES CHART ---
        if (topDiseasesData && topDiseasesData.length > 0) {
            const ctxTopDiseases = document.getElementById('topDiseasesChart').getContext('2d');
            new Chart(ctxTopDiseases, {
                type: 'bar',
                data: {
                    labels: topDiseasesData.map(d => d.disease_name),
                    datasets: [{
                        label: 'Cases',
                        data: topDiseasesData.map(d => d.disease_count),
                        backgroundColor: '#818cf8',
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { display: false } },
                },
            });
        }

        // --- 4. TOP FACILITIES CHART ---
        if (topFacilitiesData && topFacilitiesData.length > 0) {
            const ctxTopFacilities = document.getElementById('topFacilitiesChart').getContext('2d');
            new Chart(ctxTopFacilities, {
                type: 'bar',
                data: {
                    labels: topFacilitiesData.map(d => d.facility_name),
                    datasets: [{
                        label: 'Encounters',
                        data: topFacilitiesData.map(d => d.encounter_count),
                        backgroundColor: '#34d399',
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { display: false } },
                },
            });
        }
    });
</script>

{% endblock %}